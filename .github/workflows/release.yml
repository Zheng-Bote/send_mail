name: Build and Release AppImage

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04 # Required for C++23 support (GCC 13)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: '6.7.0'
          host: 'linux'
          target: 'desktop'
          arch: 'linux_gcc_64'
          install-deps: 'true'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential libssl-dev file

      - name: Configure CMake
        run: cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Install to AppDir
        run: |
          make -C build install DESTDIR=../AppDir

      - name: Generate AppImage
        env:
          QMAKE: ${{ env.Qt6_DIR }}/bin/qmake
        run: |
          # Download linuxdeploy tools
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage

          # Run linuxdeploy
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --output appimage --plugin qt

      - name: Rename AppImage
        run: |
          mv SendMail-*.AppImage SendMail.AppImage

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: SendMail.AppImage
          generate_release_notes: true
